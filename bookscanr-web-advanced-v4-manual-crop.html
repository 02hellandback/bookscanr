<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BookScanr â€” Advanced v4 (Manual Crop)</title>
  <style>
    :root { --bg:#0b0d10; --panel:#111418; --muted:#9aa4b2; --text:#e8edf2; --brand:#7cc4ff; }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text)}
    header{padding:24px 16px; border-bottom:1px solid #1b2128; background:linear-gradient(180deg,#0c1117, #0b0d10)}
    .wrap{max-width:1200px; margin:0 auto; padding:24px 16px}
    h1{margin:0 0 6px; font-size:24px}
    p.sub{margin:0; color:var(--muted)}
    .card{background:var(--panel); border:1px solid #1c232c; border-radius:16px; padding:18px; box-shadow: 0 8px 30px rgba(0,0,0,.35);}
    .grid{display:grid; gap:14px}
    @media (min-width:1100px){ .grid{grid-template-columns: 520px 1fr} }
    .btn{background:#18212b; color:#e8edf2; border:1px solid #263240; padding:10px 14px; border-radius:10px; cursor:pointer}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input[type=file]{display:block; width:100%}
    .muted{color:var(--muted)}
    footer{color:#758395; padding:24px 16px; text-align:center}
    canvas{background:#0c1117; border:1px solid #1d2630; border-radius:12px; width:100%; height:auto}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #203040; color:#9dd3ff; font-size:12px}
    textarea{width:100%; min-height: 160px; background:#0c1117; color:#e8edf2; border:1px solid #223042; border-radius:12px; padding:12px; resize:vertical}
    label, select { font-size: 14px; color:#e8edf2 }
    select { background:#18212b; border:1px solid #263240; border-radius:8px; padding:6px 10px }
    .list{margin-top:8px}
    .item{border:1px solid #223042; border-radius:12px; padding:8px; margin-bottom:8px; background:#0c1117}
    .item h4{margin:0 0 6px 0; font-size:14px}
    .item pre{white-space:pre-wrap; word-break:break-word; margin:0}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ðŸ“š BookScanr â€” Advanced v4 (Manual Crop)</h1>
      <p class="sub">When auto-segmentation struggles, draw boxes over spines/covers. Per-crop OCR with rotation attempts & filters. 100% in your browser.</p>
    </div>
  </header>

  <div class="wrap grid">
    <section class="card">
      <h3>1) Load a photo</h3>
      <input id="file" type="file" accept="image/*" />
      <div class="row" style="margin-top:10px">
        <button id="fit" class="btn">Fit</button>
        <button id="actual" class="btn">Actual size</button>
        <span class="pill">Draw to crop (drag)</span>
      </div>
      <div class="row" style="margin-top:10px">
        <label><input type="checkbox" id="sharpen" checked> Sharpen</label>
        <label><input type="checkbox" id="binarize"> Binarize</label>
        <label>PSM:
          <select id="psm">
            <option value="6" selected>6: uniform block</option>
            <option value="7">7: single text line</option>
            <option value="11">11: sparse text</option>
            <option value="12">12: sparse w/ OSD</option>
          </select>
        </label>
      </div>
      <canvas id="canvas"></canvas>
      <p class="muted">Tips: zoom to actual size before drawing; crop just the spine/cover area; try different PSM or toggle binarize if text is faint.</p>
    </section>

    <section>
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 style="margin:0">2) OCR crops</h3>
          <div class="row">
            <button id="copyAll" class="btn" disabled>Copy all</button>
            <button id="downloadTxt" class="btn" disabled>Download .txt</button>
          </div>
        </div>
        <div id="list" class="list"></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">3) Combined plain text</h3>
        <textarea id="plainText" placeholder="Crops will appear hereâ€¦" readonly></textarea>
      </div>
    </section>
  </div>

  <footer>BookScanr v4 â€” manual crop mode</footer>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script>
    const fileInput = document.getElementById('file');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let img = new Image();
    let scale = 1, offsetX=0, offsetY=0;
    let boxes = [];
    let dragging=false, startX=0, startY=0;
    const list = document.getElementById('list');
    const plainText = document.getElementById('plainText');
    const copyAll = document.getElementById('copyAll');
    const downloadTxt = document.getElementById('downloadTxt');

    function draw(){
      canvas.width = img.naturalWidth*scale;
      canvas.height = img.naturalHeight*scale;
      ctx.imageSmoothingEnabled = true;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 2; ctx.strokeStyle = '#7cc4ff'; ctx.fillStyle = 'rgba(124,196,255,0.1)';
      for(const b of boxes){
        ctx.fillRect(b.x, b.y, b.w, b.h);
        ctx.strokeRect(b.x, b.y, b.w, b.h);
      }
    }
    function fit(){
      const maxW = canvas.parentElement.clientWidth - 4;
      scale = Math.min(1, maxW / img.naturalWidth);
      draw();
    }
    function actual(){ scale = 1; draw(); }

    document.getElementById('fit').onclick = fit;
    document.getElementById('actual').onclick = actual;

    fileInput.addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      img.onload = ()=>{ fit(); boxes=[]; list.innerHTML=''; plainText.value=''; toggleExport(); };
      img.src = url;
    });

    canvas.addEventListener('mousedown', e=>{
      if(!img.src) return;
      dragging=true;
      const rect = canvas.getBoundingClientRect();
      startX = (e.clientX - rect.left);
      startY = (e.clientY - rect.top);
    });
    canvas.addEventListener('mousemove', e=>{
      if(!dragging) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left);
      const y = (e.clientY - rect.top);
      const w = x - startX, h = y - startY;
      draw();
      ctx.fillStyle = 'rgba(124,196,255,0.15)';
      ctx.strokeStyle = '#7cc4ff';
      ctx.lineWidth = 2;
      ctx.fillRect(startX, startY, w, h);
      ctx.strokeRect(startX, startY, w, h);
    });
    canvas.addEventListener('mouseup', e=>{
      if(!dragging) return; dragging=false;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left);
      const y = (e.clientY - rect.top);
      let x0 = Math.min(startX, x), y0 = Math.min(startY, y);
      let w = Math.abs(x - startX), h = Math.abs(y - startY);
      if(w<8 || h<8) return draw();
      boxes.push({ x:x0, y:y0, w, h });
      draw();
      ocrLastBox();
    });

    function toggleExport(){
      const enabled = list.children.length>0;
      copyAll.disabled = !enabled;
      downloadTxt.disabled = !enabled;
    }

    function sharpenImageData(imageData){
      // simple unsharp mask
      const w = imageData.width, h = imageData.height, d = imageData.data;
      const out = new Uint8ClampedArray(d.length);
      function idx(x,y,c){ return (y*w + x)*4 + c; }
      for(let y=1;y<h-1;y++){
        for(let x=1;x<w-1;x++){
          for(let c=0;c<3;c++){
            const val = d[idx(x,y,c)]*5 - (d[idx(x-1,y,c)]+d[idx(x+1,y,c)]+d[idx(x,y-1,c)]+d[idx(x,y+1,c)]);
            out[idx(x,y,c)] = Math.max(0, Math.min(255, val));
          }
          out[idx(x,y,3)] = 255;
        }
      }
      for(let i=0;i<d.length;i++) if(out[i]===undefined) out[i]=d[i];
      return new ImageData(out, w, h);
    }

    function binarizeImageData(imageData){
      const w=imageData.width, h=imageData.height, d=imageData.data;
      for(let i=0;i<d.length;i+=4){
        const g = 0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
        const v = g>160 ? 255 : (g<80 ? 0 : (g-80)*255/80);
        const b = v>128?255:0;
        d[i]=d[i+1]=d[i+2]=b;
      }
      return imageData;
    }

    async function ocrLastBox(){
      const b = boxes[boxes.length-1];
      if(!b) return;
      // crop to offscreen canvas at original pixels
      const oc = document.createElement('canvas');
      oc.width = Math.round(b.w / scale);
      oc.height = Math.round(b.h / scale);
      const octx = oc.getContext('2d');
      octx.imageSmoothingEnabled = true;
      octx.drawImage(img, Math.round(b.x/scale), Math.round(b.y/scale), oc.width, oc.height, 0,0, oc.width, oc.height);

      // optional filters
      if(document.getElementById('sharpen').checked){
        const id = octx.getImageData(0,0,oc.width, oc.height);
        const sharp = sharpenImageData(id);
        octx.putImageData(sharp, 0, 0);
      }
      if(document.getElementById('binarize').checked){
        const id = octx.getImageData(0,0,oc.width, oc.height);
        const bin = binarizeImageData(id);
        octx.putImageData(bin, 0, 0);
      }

      // OCR with rotations
      const psm = document.getElementById('psm').value;
      const worker = await Tesseract.createWorker();
      await worker.loadLanguage('eng'); await worker.initialize('eng');
      let best = { text:'', score:-1 }, bestAngle=0;
      for(const angle of [0,90,180,270]){
        // rotate temp
        const rc = document.createElement('canvas');
        if(angle%2===0){ rc.width=oc.width; rc.height=oc.height; }
        else { rc.width=oc.height; rc.height=oc.width; }
        const rctx = rc.getContext('2d');
        rctx.translate(rc.width/2, rc.height/2);
        rctx.rotate(angle*Math.PI/180);
        rctx.drawImage(oc, -oc.width/2, -oc.height/2);
        const { data } = await worker.recognize(rc, { config: { tessedit_pageseg_mode: psm } });
        const score = (data.text||'').replace(/\\s+/g,'').length;
        if(score>best.score){ best = { text:data.text||'' , score }; bestAngle=angle; }
      }
      await worker.terminate();

      const title = (best.text||'').split(/\\n+/).map(s=>s.trim()).filter(Boolean).slice(0,2).join(' â€” ');
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<h4>Crop ${boxes.length} <span class="muted">(angle ${bestAngle}Â°)</span></h4><pre>${best.text.replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</pre>`;
      list.appendChild(div);
      refreshPlainText();
      toggleExport();
    }

    function refreshPlainText(){
      const texts = Array.from(list.querySelectorAll('pre')).map(p=>p.textContent.trim()).filter(Boolean);
      // Take first line (title-ish) from each
      const lines = texts.map(t=> t.split(/\\n+/)[0]).filter(Boolean);
      plainText.value = lines.join('\\n');
    }

    document.getElementById('copyAll').onclick = ()=>{ plainText.select(); document.execCommand('copy'); };
    document.getElementById('downloadTxt').onclick = ()=>{
      const blob = new Blob([plainText.value], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bookscanr_crops.txt';
      a.click();
    };
  </script>
</body>
</html>
